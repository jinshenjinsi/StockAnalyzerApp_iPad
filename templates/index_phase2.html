<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— æ•Œè‚¡ç¥¨åˆ†æç³»ç»Ÿ - Phase 2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .score-badge {
            font-size: 1.2em;
            font-weight: bold;
        }
        .signal-tag {
            margin: 2px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
        }
        .price-change {
            font-weight: bold;
        }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .neutral { color: #6c757d; }
        .mini-chart {
            width: 100px;
            height: 40px;
        }
        .alert-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .favorites-section {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .technical-indicator {
            margin: 5px 0;
            padding: 8px;
            background-color: #f1f3f5;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">ğŸ¦ æ— æ•Œè‚¡ç¥¨åˆ†æç³»ç»Ÿ - Phase 2</h1>
                
                <!-- è‚¡ç¥¨æŸ¥è¯¢è¡¨å• -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form method="POST" class="row g-3">
                            <div class="col-md-8">
                                <input type="text" class="form-control" name="symbol" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚: AAPL, 600519)" required>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary w-100">åˆ†æè‚¡ç¥¨</button>
                            </div>
                        </form>
                    </div>
                </div>

                {% if result %}
                {% if result.error %}
                <div class="alert alert-danger">{{ result.error }}</div>
                {% else %}
                <!-- è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3>{{ result.name }} ({{ result.symbol }}) - {{ result.market_type }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h4>{{ result.currency }}{{ result.current_price }}</h4>
                                <span class="price-change {% if result.change >= 0 %}positive{% else %}negative{% endif %}">
                                    {{ "%+.2f"|format(result.change) }}%
                                </span>
                                <p class="text-muted">æˆäº¤é‡: {{ result.volume }}</p>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="mini-chart" id="miniChart"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç»¼åˆè¯„åˆ†å’Œå»ºè®® -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>ç»¼åˆè¯„åˆ†</h5>
                            </div>
                            <div class="card-body text-center">
                                <div class="score-badge 
                                    {% if result.overall_score >= 80 %}text-success
                                    {% elif result.overall_score >= 60 %}text-primary
                                    {% elif result.overall_score >= 40 %}text-warning
                                    {% else %}text-danger{% endif %}">
                                    {{ result.overall_score }}/100
                                </div>
                                <p class="mt-2">{{ result.suggestion }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>äº¤æ˜“ä¿¡å·</h5>
                            </div>
                            <div class="card-body">
                                {% for signal in result.signals %}
                                <span class="signal-tag bg-info text-white">{{ signal }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é«˜çº§æŠ€æœ¯æŒ‡æ ‡ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>é«˜çº§æŠ€æœ¯æŒ‡æ ‡</h5>
                    </div>
                    <div class="card-body">
                        {% if result.advanced_indicators %}
                        <div class="row">
                            <div class="col-md-4">
                                <div class="technical-indicator">
                                    <strong>MACD:</strong> {{ "%.2f"|format(result.advanced_indicators.macd.macd) }}
                                    <br><small>Signal: {{ "%.2f"|format(result.advanced_indicators.macd.signal) }}, Histogram: {{ "%.2f"|format(result.advanced_indicators.macd.histogram) }}</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="technical-indicator">
                                    <strong>RSI (14):</strong> {{ "%.2f"|format(result.advanced_indicators.rsi) }}
                                    <br><small>{% if result.advanced_indicators.rsi < 30 %}è¶…å–åŒºåŸŸ{% elif result.advanced_indicators.rsi > 70 %}è¶…ä¹°åŒºåŸŸ{% else %}æ­£å¸¸åŒºåŸŸ{% endif %}</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="technical-indicator">
                                    <strong>å¸ƒæ—å¸¦:</strong>
                                    <br><small>ä¸Šè½¨: {{ "%.2f"|format(result.advanced_indicators.bollinger.upper) }}</small>
                                    <br><small>ä¸‹è½¨: {{ "%.2f"|format(result.advanced_indicators.bollinger.lower) }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ–°å¢æŒ‡æ ‡ -->
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <div class="technical-indicator">
                                    <strong>ADX:</strong> {{ "%.2f"|format(result.advanced_indicators.adx) }}
                                    <br><small>{% if result.advanced_indicators.adx > 25 %}è¶‹åŠ¿å¼ºåŠ²{% else %}è¶‹åŠ¿è¾ƒå¼±{% endif %}</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="technical-indicator">
                                    <strong>Williams %R:</strong> {{ "%.2f"|format(result.advanced_indicators.williams_r) }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="technical-indicator">
                                    <strong>OBV:</strong> {{ "%.0f"|format(result.advanced_indicators.obv) }}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="technical-indicator">
                                    <strong>ATR:</strong> {{ "%.2f"|format(result.advanced_indicators.atr) }}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- æ”¯æ’‘ä½å’Œé˜»åŠ›ä½ -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>æ”¯æ’‘ä½</h5>
                            </div>
                            <div class="card-body text-center">
                                {% if result.support_level %}
                                <h5>{{ result.currency }}{{ result.support_level }}</h5>
                                <small>{{ "%+.2f"|format(result.support_pct) }}%</small>
                                {% else %}
                                <p class="text-muted">æš‚æ— æ•°æ®</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5>é˜»åŠ›ä½</h5>
                            </div>
                            <div class="card-body text-center">
                                {% if result.resistance_level %}
                                <h5>{{ result.currency }}{{ result.resistance_level }}</h5>
                                <small>{{ "%+.2f"|format(result.resistance_pct) }}%</small>
                                {% else %}
                                <p class="text-muted">æš‚æ— æ•°æ®</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é¢„è­¦ç³»ç»Ÿ -->
                <div class="alert-section">
                    <h5>ğŸš¨ é¢„è­¦è®¾ç½®</h5>
                    <form id="alertForm" class="row g-2">
                        <div class="col-md-3">
                            <input type="number" class="form-control form-control-sm" id="priceAlert" placeholder="ä»·æ ¼é¢„è­¦" step="0.01">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="indicatorAlert">
                                <option value="">æŠ€æœ¯æŒ‡æ ‡é¢„è­¦</option>
                                <option value="rsi_overbought">RSIè¶…ä¹° (>70)</option>
                                <option value="rsi_oversold">RSIè¶…å– (<30)</option>
                                <option value="macd_bullish">MACDé‡‘å‰</option>
                                <option value="macd_bearish">MACDæ­»å‰</option>
                                <option value="bb_breakout_upper">çªç ´å¸ƒæ—å¸¦ä¸Šè½¨</option>
                                <option value="bb_breakout_lower">è·Œç ´å¸ƒæ—å¸¦ä¸‹è½¨</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="alertMethod">
                                <option value="email">é‚®ä»¶é€šçŸ¥</option>
                                <option value="sms">çŸ­ä¿¡é€šçŸ¥</option>
                                <option value="push">æ¨é€é€šçŸ¥</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-success btn-sm w-100" onclick="setAlert()">è®¾ç½®é¢„è­¦</button>
                        </div>
                    </form>
                    <div id="alertStatus" class="mt-2"></div>
                </div>

                <!-- æ”¶è—å¤¹ç®¡ç† -->
                <div class="favorites-section">
                    <h5>â­ æ”¶è—å¤¹ç®¡ç†</h5>
                    <form id="favoritesForm" class="row g-2">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" id="favoriteGroup" placeholder="åˆ†ç»„åç§° (å¯é€‰)">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select form-select-sm" id="favoriteAction">
                                <option value="add">æ·»åŠ åˆ°æ”¶è—</option>
                                <option value="remove">ä»æ”¶è—ç§»é™¤</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-warning btn-sm w-100" onclick="manageFavorite()">æ“ä½œ</button>
                        </div>
                    </form>
                    <div id="favoritesStatus" class="mt-2"></div>
                </div>

                <!-- æ•°æ®æºä¿¡æ¯ -->
                <div class="alert alert-info">
                    <strong>æ•°æ®æº:</strong> {{ result.data_source }} | <strong>ç­–ç•¥:</strong> {{ result.strategy }}
                </div>
                {% endif %}
                {% endif %}

                <!-- å¯¼èˆªé“¾æ¥ -->
                <div class="text-center mt-4">
                    <a href="/ranking?market=US" class="btn btn-outline-secondary me-2">ç¾è‚¡æ’å</a>
                    <a href="/ranking?market=CN" class="btn btn-outline-secondary me-2">Aè‚¡æ’å</a>
                    <a href="/screener" class="btn btn-outline-secondary">æ™ºèƒ½é€‰è‚¡</a>
                    <a href="/alerts" class="btn btn-outline-success">æˆ‘çš„é¢„è­¦</a>
                    <a href="/favorites" class="btn btn-outline-warning">æˆ‘çš„æ”¶è—</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // æ¸²æŸ“è¿·ä½ èµ°åŠ¿å›¾
        {% if result and result.recent_prices %}
        const ctx = document.getElementById('miniChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array({{ result.recent_prices|length }}).fill(''),
                datasets: [{
                    data: {{ result.recent_prices|tojson }},
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 1,
                    pointRadius: 0,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                scales: {
                    x: { display: false },
                    y: { display: false }
                }
            }
        });
        {% endif %}

        // é¢„è­¦è®¾ç½®å‡½æ•°
        function setAlert() {
            const priceAlert = document.getElementById('priceAlert').value;
            const indicatorAlert = document.getElementById('indicatorAlert').value;
            const alertMethod = document.getElementById('alertMethod').value;
            
            if (!priceAlert && !indicatorAlert) {
                showStatus('alertStatus', 'è¯·è®¾ç½®è‡³å°‘ä¸€ä¸ªé¢„è­¦æ¡ä»¶', 'danger');
                return;
            }
            
            // è¿™é‡Œåº”è¯¥å‘é€AJAXè¯·æ±‚åˆ°åç«¯
            showStatus('alertStatus', 'é¢„è­¦è®¾ç½®æˆåŠŸï¼', 'success');
        }

        // æ”¶è—å¤¹ç®¡ç†å‡½æ•°
        function manageFavorite() {
            const favoriteGroup = document.getElementById('favoriteGroup').value;
            const favoriteAction = document.getElementById('favoriteAction').value;
            
            // è¿™é‡Œåº”è¯¥å‘é€AJAXè¯·æ±‚åˆ°åç«¯
            const actionText = favoriteAction === 'add' ? 'æ·»åŠ ' : 'ç§»é™¤';
            showStatus('favoritesStatus', `å·²${actionText}åˆ°æ”¶è—å¤¹ï¼`, 'success');
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }
    </script>
</body>
</html>