<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自选股管理 - 股票分析系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .stock-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: box-shadow 0.3s ease;
        }
        .stock-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .price-change.positive { color: #28a745; }
        .price-change.negative { color: #dc3545; }
        .score-badge {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        .group-selector {
            margin-bottom: 20px;
        }
        .alert-item {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">股票分析系统</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/ranking">股票排名</a>
                <a class="nav-link" href="/screener">智能选股</a>
                <a class="nav-link active" href="/favorites">自选股</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>自选股管理</h2>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addStockModal">
                <i class="fas fa-plus"></i> 添加股票
            </button>
        </div>

        <!-- 分组选择器 -->
        <div class="group-selector">
            <label for="groupSelect" class="form-label">选择分组:</label>
            <select class="form-select" id="groupSelect" onchange="loadGroup(this.value)">
                <option value="all">全部股票</option>
                {% for group in groups %}
                <option value="{{ group }}">{{ group }}</option>
                {% endfor %}
                <option value="new">新建分组...</option>
            </select>
        </div>

        <!-- 警报区域 -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">实时警报</h5>
            </div>
            <div class="card-body" id="alertsContainer">
                {% if alerts %}
                    {% for alert in alerts %}
                    <div class="alert-item">
                        <strong>{{ alert.symbol }}</strong> - {{ alert.message }}
                        <small class="text-muted">{{ alert.timestamp }}</small>
                        <button class="btn btn-sm btn-outline-danger float-end" onclick="dismissAlert('{{ alert.id }}')">
                            忽略
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">暂无警报</p>
                {% endif %}
            </div>
        </div>

        <!-- 股票列表 -->
        <div id="stocksContainer">
            {% if stocks %}
                <div class="row">
                    {% for stock in stocks %}
                    <div class="col-md-6 col-lg-4" data-group="{{ stock.group }}">
                        <div class="stock-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="mb-1">{{ stock.symbol }}</h5>
                                    <p class="text-muted mb-1">{{ stock.name }}</p>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeStock('{{ stock.symbol }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <div class="mt-2">
                                <div class="d-flex justify-content-between">
                                    <span>当前价格:</span>
                                    <strong>{{ stock.current_price }}{{ stock.currency }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mt-1">
                                    <span>涨跌幅:</span>
                                    <span class="price-change {% if stock.change >= 0 %}positive{% else %}negative{% endif %}">
                                        {{ "%.2f"|format(stock.change) }}%
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between mt-1">
                                    <span>综合评分:</span>
                                    <span>
                                        <span class="badge score-badge 
                                            {% if stock.overall_score >= 80 %}bg-success
                                            {% elif stock.overall_score >= 60 %}bg-primary
                                            {% elif stock.overall_score >= 40 %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {{ stock.overall_score }}
                                        </span>
                                    </span>
                                </div>
                            </div>

                            <div class="mt-3">
                                <small class="text-muted">分组: {{ stock.group }}</small>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="analyzeStock('{{ stock.symbol }}')">
                                        详细分析
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="editStockGroup('{{ stock.symbol }}', '{{ stock.group }}')">
                                        更改分组
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <p class="text-muted">暂无自选股</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStockModal">
                        添加第一只股票
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- 添加股票模态框 -->
    <div class="modal fade" id="addStockModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加股票</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStockForm">
                        <div class="mb-3">
                            <label for="stockSymbol" class="form-label">股票代码</label>
                            <input type="text" class="form-control" id="stockSymbol" required>
                            <div class="form-text">例如: AAPL (美股), 600036 (A股)</div>
                        </div>
                        <div class="mb-3">
                            <label for="stockGroup" class="form-label">分组</label>
                            <select class="form-select" id="stockGroup">
                                <option value="默认分组">默认分组</option>
                                {% for group in groups %}
                                <option value="{{ group }}">{{ group }}</option>
                                {% endfor %}
                                <option value="new">新建分组...</option>
                            </select>
                        </div>
                        <div class="mb-3" id="newGroupInput" style="display:none;">
                            <label for="newGroupName" class="form-label">新分组名称</label>
                            <input type="text" class="form-control" id="newGroupName">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addStock()">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑分组模态框 -->
    <div class="modal fade" id="editGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">更改分组</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editGroupForm">
                        <input type="hidden" id="editStockSymbol">
                        <div class="mb-3">
                            <label for="editStockGroup" class="form-label">选择分组</label>
                            <select class="form-select" id="editStockGroup">
                                <option value="默认分组">默认分组</option>
                                {% for group in groups %}
                                <option value="{{ group }}">{{ group }}</option>
                                {% endfor %}
                                <option value="new">新建分组...</option>
                            </select>
                        </div>
                        <div class="mb-3" id="editNewGroupInput" style="display:none;">
                            <label for="editNewGroupName" class="form-label">新分组名称</label>
                            <input type="text" class="form-control" id="editNewGroupName">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveStockGroup()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        // 处理新建分组选项
        document.getElementById('stockGroup').addEventListener('change', function() {
            const newGroupInput = document.getElementById('newGroupInput');
            if (this.value === 'new') {
                newGroupInput.style.display = 'block';
            } else {
                newGroupInput.style.display = 'none';
            }
        });

        document.getElementById('editStockGroup').addEventListener('change', function() {
            const newGroupInput = document.getElementById('editNewGroupInput');
            if (this.value === 'new') {
                newGroupInput.style.display = 'block';
            } else {
                newGroupInput.style.display = 'none';
            }
        });

        // 添加股票
        function addStock() {
            const symbol = document.getElementById('stockSymbol').value.trim().toUpperCase();
            let group = document.getElementById('stockGroup').value;
            
            if (group === 'new') {
                group = document.getElementById('newGroupName').value.trim();
                if (!group) {
                    alert('请输入分组名称');
                    return;
                }
            }
            
            if (!symbol) {
                alert('请输入股票代码');
                return;
            }
            
            fetch('/api/add_favorite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    symbol: symbol,
                    group: group
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('添加失败: ' + data.error);
                }
            })
            .catch(error => {
                alert('网络错误: ' + error);
            });
        }

        // 删除股票
        function removeStock(symbol) {
            if (confirm('确定要删除 ' + symbol + ' 吗？')) {
                fetch('/api/remove_favorite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol: symbol })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('删除失败: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('网络错误: ' + error);
                });
            }
        }

        // 编辑股票分组
        function editStockGroup(symbol, currentGroup) {
            document.getElementById('editStockSymbol').value = symbol;
            document.getElementById('editStockGroup').value = currentGroup;
            document.getElementById('editNewGroupInput').style.display = 'none';
            const editModal = new bootstrap.Modal(document.getElementById('editGroupModal'));
            editModal.show();
        }

        // 保存股票分组
        function saveStockGroup() {
            const symbol = document.getElementById('editStockSymbol').value;
            let group = document.getElementById('editStockGroup').value;
            
            if (group === 'new') {
                group = document.getElementById('editNewGroupName').value.trim();
                if (!group) {
                    alert('请输入分组名称');
                    return;
                }
            }
            
            fetch('/api/update_favorite_group', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    symbol: symbol,
                    group: group
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('更新失败: ' + data.error);
                }
            })
            .catch(error => {
                alert('网络错误: ' + error);
            });
        }

        // 分析股票
        function analyzeStock(symbol) {
            window.location.href = '/?symbol=' + symbol;
        }

        // 加载指定分组
        function loadGroup(group) {
            if (group === 'new') {
                const newGroupName = prompt('请输入新分组名称:');
                if (newGroupName) {
                    // 创建新分组并刷新页面
                    fetch('/api/create_group', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ group_name: newGroupName })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('创建分组失败: ' + data.error);
                        }
                    });
                }
                return;
            }
            
            // 过滤显示指定分组的股票
            const stockCards = document.querySelectorAll('.stock-card');
            stockCards.forEach(card => {
                const cardGroup = card.closest('[data-group]').dataset.group;
                if (group === 'all' || cardGroup === group) {
                    card.closest('[data-group]').style.display = '';
                } else {
                    card.closest('[data-group]').style.display = 'none';
                }
            });
        }

        // 忽略警报
        function dismissAlert(alertId) {
            fetch('/api/dismiss_alert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ alert_id: alertId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 移除警报元素
                    const alertElement = document.querySelector(`[data-alert-id="${alertId}"]`);
                    if (alertElement) {
                        alertElement.remove();
                    }
                }
            });
        }

        // 自动刷新警报（每30秒）
        setInterval(() => {
            fetch('/api/get_alerts')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.alerts) {
                        const container = document.getElementById('alertsContainer');
                        if (data.alerts.length > 0) {
                            let html = '';
                            data.alerts.forEach(alert => {
                                html += `
                                    <div class="alert-item" data-alert-id="${alert.id}">
                                        <strong>${alert.symbol}</strong> - ${alert.message}
                                        <small class="text-muted">${alert.timestamp}</small>
                                        <button class="btn btn-sm btn-outline-danger float-end" onclick="dismissAlert('${alert.id}')">
                                            忽略
                                        </button>
                                    </div>
                                `;
                            });
                            container.innerHTML = html;
                        } else {
                            container.innerHTML = '<p class="text-muted">暂无警报</p>';
                        }
                    }
                })
                .catch(error => {
                    console.log('获取警报失败:', error);
                });
        }, 30000);
    </script>
</body>
</html>