<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„è­¦ç³»ç»Ÿ - æ— æ•Œè‚¡ç¥¨åˆ†æç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .alert-card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        .alert-card:hover {
            transform: translateY(-2px);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active { background-color: #28a745; }
        .status-inactive { background-color: #dc3545; }
        .price-input {
            max-width: 150px;
        }
        .notification-method {
            display: flex;
            gap: 10px;
            align-items: center;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">æ— æ•Œè‚¡ç¥¨åˆ†æç³»ç»Ÿ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/">è‚¡ç¥¨åˆ†æ</a></li>
                    <li class="nav-item"><a class="nav-link" href="/ranking">è‚¡ç¥¨æ’å</a></li>
                    <li class="nav-item"><a class="nav-link" href="/screener">æ™ºèƒ½é€‰è‚¡</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/alerts">é¢„è­¦ç³»ç»Ÿ</a></li>
                    <li class="nav-item"><a class="nav-link" href="/favorites">æ”¶è—å¤¹</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">ğŸ“ˆ é¢„è­¦ç³»ç»Ÿ</h2>
                
                <!-- åˆ›å»ºæ–°é¢„è­¦ -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">åˆ›å»ºæ–°é¢„è­¦</h5>
                    </div>
                    <div class="card-body">
                        <form id="createAlertForm">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="alertSymbol" class="form-label">è‚¡ç¥¨ä»£ç </label>
                                    <input type="text" class="form-control" id="alertSymbol" placeholder="AAPL" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="alertType" class="form-label">é¢„è­¦ç±»å‹</label>
                                    <select class="form-select" id="alertType" required>
                                        <option value="price_above">ä»·æ ¼çªç ´ä¸Šé™</option>
                                        <option value="price_below">ä»·æ ¼è·Œç ´ä¸‹é™</option>
                                        <option value="rsi_overbought">RSIè¶…ä¹°</option>
                                        <option value="rsi_oversold">RSIè¶…å–</option>
                                        <option value="macd_bullish">MACDé‡‘å‰</option>
                                        <option value="macd_bearish">MACDæ­»å‰</option>
                                        <option value="bollinger_upper">è§¦åŠå¸ƒæ—å¸¦ä¸Šè½¨</option>
                                        <option value="bollinger_lower">è§¦åŠå¸ƒæ—å¸¦ä¸‹è½¨</option>
                                    </select>
                                </div>
                                <div class="col-md-3" id="priceThresholdGroup">
                                    <label for="priceThreshold" class="form-label">ä»·æ ¼é˜ˆå€¼</label>
                                    <input type="number" class="form-control price-input" id="priceThreshold" step="0.01" placeholder="150.00">
                                </div>
                                <div class="col-md-3">
                                    <label for="notificationMethod" class="form-label">é€šçŸ¥æ–¹å¼</label>
                                    <select class="form-select" id="notificationMethod" required>
                                        <option value="email">é‚®ç®±</option>
                                        <option value="sms">çŸ­ä¿¡</option>
                                        <option value="push">æ¨é€é€šçŸ¥</option>
                                        <option value="web">ç½‘é¡µæé†’</option>
                                    </select>
                                </div>
                                <div class="col-md-12">
                                    <button type="submit" class="btn btn-primary">åˆ›å»ºé¢„è­¦</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- ç°æœ‰é¢„è­¦åˆ—è¡¨ -->
                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">æˆ‘çš„é¢„è­¦</h5>
                        <span id="alertCount" class="badge bg-secondary">0 ä¸ªé¢„è­¦</span>
                    </div>
                    <div class="card-body">
                        <div id="alertsList" class="row g-3">
                            <!-- é¢„è­¦é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é¢„è­¦è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="alertDetailModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">é¢„è­¦è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="alertDetailContent">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-danger" id="deleteAlertBtn">åˆ é™¤é¢„è­¦</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // é¢„è­¦ç±»å‹ä¸ä»·æ ¼é˜ˆå€¼æ˜¾ç¤ºé€»è¾‘
        document.getElementById('alertType').addEventListener('change', function() {
            const priceGroup = document.getElementById('priceThresholdGroup');
            const priceInput = document.getElementById('priceThreshold');
            
            const priceBasedTypes = ['price_above', 'price_below'];
            if (priceBasedTypes.includes(this.value)) {
                priceGroup.style.display = 'block';
                priceInput.required = true;
            } else {
                priceGroup.style.display = 'none';
                priceInput.required = false;
                priceInput.value = '';
            }
        });

        // åŠ è½½ç°æœ‰é¢„è­¦
        async function loadAlerts() {
            try {
                const response = await fetch('/api/get_alerts');
                const data = await response.json();
                
                if (data.success) {
                    const alertsList = document.getElementById('alertsList');
                    const alertCount = document.getElementById('alertCount');
                    
                    alertsList.innerHTML = '';
                    alertCount.textContent = `${data.alerts.length} ä¸ªé¢„è­¦`;
                    
                    data.alerts.forEach(alert => {
                        const alertCard = document.createElement('div');
                        alertCard.className = 'col-md-6 col-lg-4';
                        alertCard.innerHTML = `
                            <div class="alert-card p-3 border">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="mb-1">${alert.symbol}</h6>
                                        <small class="text-muted">${getAlertTypeName(alert.type)}</small>
                                    </div>
                                    <div>
                                        <span class="status-indicator ${alert.active ? 'status-active' : 'status-inactive'}"></span>
                                    </div>
                                </div>
                                ${alert.threshold ? `<p class="mb-2 small">é˜ˆå€¼: ${alert.threshold}</p>` : ''}
                                <p class="mb-2 small">é€šçŸ¥: ${getNotificationMethodName(alert.notification_method)}</p>
                                <p class="mb-2 small">åˆ›å»ºæ—¶é—´: ${new Date(alert.created_at).toLocaleString()}</p>
                                <button class="btn btn-sm btn-outline-primary view-alert-btn" data-id="${alert.id}">
                                    æŸ¥çœ‹è¯¦æƒ…
                                </button>
                            </div>
                        `;
                        alertsList.appendChild(alertCard);
                    });
                    
                    // æ·»åŠ æŸ¥çœ‹è¯¦æƒ…äº‹ä»¶ç›‘å¬
                    document.querySelectorAll('.view-alert-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const alertId = this.getAttribute('data-id');
                            showAlertDetail(alertId);
                        });
                    });
                }
            } catch (error) {
                console.error('åŠ è½½é¢„è­¦å¤±è´¥:', error);
            }
        }

        function getAlertTypeName(type) {
            const types = {
                'price_above': 'ä»·æ ¼çªç ´ä¸Šé™',
                'price_below': 'ä»·æ ¼è·Œç ´ä¸‹é™',
                'rsi_overbought': 'RSIè¶…ä¹°',
                'rsi_oversold': 'RSIè¶…å–',
                'macd_bullish': 'MACDé‡‘å‰',
                'macd_bearish': 'MACDæ­»å‰',
                'bollinger_upper': 'è§¦åŠå¸ƒæ—å¸¦ä¸Šè½¨',
                'bollinger_lower': 'è§¦åŠå¸ƒæ—å¸¦ä¸‹è½¨'
            };
            return types[type] || type;
        }

        function getNotificationMethodName(method) {
            const methods = {
                'email': 'é‚®ç®±',
                'sms': 'çŸ­ä¿¡',
                'push': 'æ¨é€é€šçŸ¥',
                'web': 'ç½‘é¡µæé†’'
            };
            return methods[method] || method;
        }

        // æ˜¾ç¤ºé¢„è­¦è¯¦æƒ…
        async function showAlertDetail(alertId) {
            try {
                const response = await fetch(`/api/get_alert/${alertId}`);
                const data = await response.json();
                
                if (data.success) {
                    const alert = data.alert;
                    document.getElementById('alertDetailContent').innerHTML = `
                        <div class="mb-3">
                            <strong>è‚¡ç¥¨ä»£ç :</strong> ${alert.symbol}
                        </div>
                        <div class="mb-3">
                            <strong>é¢„è­¦ç±»å‹:</strong> ${getAlertTypeName(alert.type)}
                        </div>
                        ${alert.threshold ? `<div class="mb-3"><strong>ä»·æ ¼é˜ˆå€¼:</strong> ${alert.threshold}</div>` : ''}
                        <div class="mb-3">
                            <strong>é€šçŸ¥æ–¹å¼:</strong> ${getNotificationMethodName(alert.notification_method)}
                        </div>
                        <div class="mb-3">
                            <strong>çŠ¶æ€:</strong> 
                            <span class="badge ${alert.active ? 'bg-success' : 'bg-danger'}">
                                ${alert.active ? 'æ¿€æ´»' : 'åœç”¨'}
                            </span>
                        </div>
                        <div class="mb-3">
                            <strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(alert.created_at).toLocaleString()}
                        </div>
                        ${alert.last_triggered ? `<div class="mb-3"><strong>æœ€åè§¦å‘:</strong> ${new Date(alert.last_triggered).toLocaleString()}</div>` : ''}
                    `;
                    
                    // è®¾ç½®åˆ é™¤æŒ‰é’®çš„ID
                    document.getElementById('deleteAlertBtn').setAttribute('data-id', alertId);
                    
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    const modal = new bootstrap.Modal(document.getElementById('alertDetailModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('è·å–é¢„è­¦è¯¦æƒ…å¤±è´¥:', error);
            }
        }

        // åˆ é™¤é¢„è­¦
        document.getElementById('deleteAlertBtn').addEventListener('click', async function() {
            const alertId = this.getAttribute('data-id');
            if (!alertId) return;
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„è­¦å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/delete_alert/${alertId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('alertDetailModal')).hide();
                    loadAlerts(); // é‡æ–°åŠ è½½é¢„è­¦åˆ—è¡¨
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤é¢„è­¦å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        // åˆ›å»ºæ–°é¢„è­¦
        document.getElementById('createAlertForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const alertData = {
                symbol: formData.get('alertSymbol').trim().toUpperCase(),
                type: formData.get('alertType'),
                threshold: formData.get('priceThreshold') || null,
                notification_method: formData.get('notificationMethod')
            };
            
            // éªŒè¯è‚¡ç¥¨ä»£ç 
            if (!alertData.symbol) {
                alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }
            
            // éªŒè¯ä»·æ ¼é˜ˆå€¼ï¼ˆå¦‚æœæ˜¯ä»·æ ¼ç±»é¢„è­¦ï¼‰
            if (['price_above', 'price_below'].includes(alertData.type) && !alertData.threshold) {
                alert('è¯·è¾“å…¥ä»·æ ¼é˜ˆå€¼');
                return;
            }
            
            try {
                const response = await fetch('/api/create_alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(alertData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('é¢„è­¦åˆ›å»ºæˆåŠŸï¼');
                    this.reset();
                    loadAlerts(); // é‡æ–°åŠ è½½é¢„è­¦åˆ—è¡¨
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ›å»ºé¢„è­¦å¤±è´¥:', error);
                alert('åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadAlerts();
            
            // åˆå§‹åŒ–ä»·æ ¼é˜ˆå€¼ç»„çš„æ˜¾ç¤ºçŠ¶æ€
            const alertType = document.getElementById('alertType');
            const priceGroup = document.getElementById('priceThresholdGroup');
            if (!['price_above', 'price_below'].includes(alertType.value)) {
                priceGroup.style.display = 'none';
            }
        });
    </script>
</body>
</html>