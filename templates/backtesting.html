<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­–ç•¥å›æµ‹ - æ— æ•Œè‚¡ç¥¨åˆ†æç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">ğŸ¦ æ— æ•Œè‚¡ç¥¨åˆ†æç³»ç»Ÿ</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/ml">MLé¢„æµ‹</a>
                <a class="nav-link" href="/sentiment">æƒ…ç»ªåˆ†æ</a>
                <a class="nav-link active" href="/backtest">å›æµ‹</a>
                <a class="nav-link" href="/favorites">æ”¶è—</a>
                <a class="nav-link" href="/alerts">æé†’</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <h2>ç­–ç•¥å›æµ‹</h2>
                <p>æµ‹è¯•ä¸åŒäº¤æ˜“ç­–ç•¥åœ¨å†å²æ•°æ®ä¸Šçš„è¡¨ç°ï¼Œè¯„ä¼°ç­–ç•¥çš„æœ‰æ•ˆæ€§ã€‚</p>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>å›æµ‹ç»“æœ</h5>
                    </div>
                    <div class="card-body">
                        <div id="backtest-results">
                            <!-- Dynamic content will be loaded here -->
                            <div class="text-center text-muted">
                                <p>é…ç½®å›æµ‹å‚æ•°å¼€å§‹æµ‹è¯•</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>å›æµ‹é…ç½®</h5>
                    </div>
                    <div class="card-body">
                        <form id="backtest-form">
                            <div class="mb-3">
                                <label for="backtest-symbol" class="form-label">è‚¡ç¥¨ä»£ç </label>
                                <input type="text" class="form-control" id="backtest-symbol" placeholder="ä¾‹å¦‚: AAPL" required>
                            </div>
                            <div class="mb-3">
                                <label for="strategy" class="form-label">ç­–ç•¥é€‰æ‹©</label>
                                <select class="form-select" id="strategy" required>
                                    <option value="SMA_Crossover">SMAäº¤å‰ç­–ç•¥</option>
                                    <option value="RSI_Strategy">RSIç­–ç•¥</option>
                                    <option value="MACD_Strategy">MACDç­–ç•¥</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="start-date" class="form-label">å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="start-date" required>
                            </div>
                            <div class="mb-3">
                                <label for="end-date" class="form-label">ç»“æŸæ—¥æœŸ</label>
                                <input type="date" class="form-control" id="end-date" required>
                            </div>
                            <div class="mb-3">
                                <label for="capital" class="form-label">åˆå§‹èµ„é‡‘</label>
                                <input type="number" class="form-control" id="capital" value="10000" min="100" step="100">
                            </div>
                            <button type="submit" class="btn btn-primary w-100">å¼€å§‹å›æµ‹</button>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>ç­–ç•¥è¯´æ˜</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled">
                            <li><strong>SMAäº¤å‰ç­–ç•¥</strong>: åŸºäºçŸ­æœŸå’Œé•¿æœŸç§»åŠ¨å¹³å‡çº¿äº¤å‰</li>
                            <li><strong>RSIç­–ç•¥</strong>: åŸºäºç›¸å¯¹å¼ºå¼±æŒ‡æ•°è¶…ä¹°è¶…å–ä¿¡å·</li>
                            <li><strong>MACDç­–ç•¥</strong>: åŸºäºMACDæŒ‡æ ‡çš„ä¹°å–ä¿¡å·</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Set default dates (last year to today)
        const today = new Date();
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(today.getFullYear() - 1);
        
        document.getElementById('start-date').valueAsDate = oneYearAgo;
        document.getElementById('end-date').valueAsDate = today;
        
        document.getElementById('backtest-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                symbol: document.getElementById('backtest-symbol').value.toUpperCase(),
                strategy: document.getElementById('strategy').value,
                startDate: document.getElementById('start-date').value,
                endDate: document.getElementById('end-date').value,
                capital: parseFloat(document.getElementById('capital').value)
            };
            
            try {
                const response = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('backtest-results').innerHTML = 
                        `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                const performance = data.performance;
                const totalReturnPercent = (performance.total_return * 100).toFixed(2);
                const winRatePercent = (performance.win_rate * 100).toFixed(1);
                
                let returnColor = 'secondary';
                if (performance.total_return > 0) {
                    returnColor = 'success';
                } else if (performance.total_return < 0) {
                    returnColor = 'danger';
                }
                
                const html = `
                    <div class="row">
                        <div class="col-md-6">
                            <h4>${formData.symbol} - ${formData.strategy}</h4>
                            <p><strong>å›æµ‹æœŸé—´:</strong> ${formData.startDate} åˆ° ${formData.endDate}</p>
                            <p><strong>åˆå§‹èµ„é‡‘:</strong> $${formData.capital.toLocaleString()}</p>
                            <p><strong>æœ€ç»ˆä»·å€¼:</strong> $${performance.final_value.toLocaleString()}</p>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-${returnColor} text-white">
                                <div class="card-body text-center">
                                    <h5>æ€»æ”¶ç›Š</h5>
                                    <h3 class="mb-0">${totalReturnPercent}%</h3>
                                </div>
                            </div>
                            <div class="mt-3">
                                <p><strong>èƒœç‡:</strong> ${winRatePercent}%</p>
                                <p><strong>æœ€å¤§å›æ’¤:</strong> ${(performance.max_drawdown * 100).toFixed(2)}%</p>
                                <p><strong>å¤æ™®æ¯”ç‡:</strong> ${performance.sharpe_ratio.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h5>äº¤æ˜“è®°å½• (${data.trades.length} ç¬”)</h5>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>æ—¥æœŸ</th>
                                        <th>ç±»å‹</th>
                                        <th>ä»·æ ¼</th>
                                        <th>æ•°é‡</th>
                                        <th>ç›ˆäº</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.trades.map(trade => `
                                        <tr>
                                            <td>${trade.date}</td>
                                            <td>${trade.type}</td>
                                            <td>$${trade.price.toFixed(2)}</td>
                                            <td>${trade.quantity}</td>
                                            <td class="${trade.profit >= 0 ? 'text-success' : 'text-danger'}">
                                                $${trade.profit.toFixed(2)}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('backtest-results').innerHTML = html;
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('backtest-results').innerHTML = 
                    `<div class="alert alert-danger">å›æµ‹å¤±è´¥: ${error.message}</div>`;
            }
        });
    </script>
</body>
</html>